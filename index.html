<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Yediemin Otopark Pro - APK Uyumlu</title>
<style>
    /* Zoom ve Dokunma AyarlarÄ± */
    html, body {
        touch-action: manipulation;
        overflow-x: hidden;
        transition: transform 0.2s ease-in-out;
        transform-origin: 0 0;
    }

    body{font-family:'Segoe UI',Arial;background:#f0f2f5;padding:15px;margin:0}
    nav{background:#2c3e50;padding:10px;display:flex;justify-content:center;gap:5px;margin-bottom:20px;flex-wrap:wrap}
    nav button{padding:8px 12px;cursor:pointer;background:#34495e;color:white;border:none;border-radius:4px;transition:0.3s;font-size:14px;flex:1}
    nav button:hover{background:#1abc9c}
    .page{display:none;max-width:1400px;margin:0 auto;background:#fff;padding:15px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
    .active{display:block}
    
    .uyari-karti{padding:10px;margin:10px 0;border-radius:6px;display:none;font-weight:bold}
    .iceride{background:#fff3cd;border:1px solid #ffeeba;color:#856404}
    .teslim-edilmis{background:#d4edda;border:1px solid #c3e6cb;color:#155724}

    .ocr-alan{border:2px dashed #3498db;padding:15px;text-align:center;background:#f8fbff;margin-bottom:15px}
    
    /* Input odaklandÄ±ÄŸÄ±nda bÃ¼yÃ¼memesi iÃ§in font-size 16px yapÄ±ldÄ± */
    input,select,button,textarea{
        padding:10px;margin:5px 0;width:100%;box-sizing:border-box;border:1px solid #ddd;
        border-radius:4px;font-family:inherit;font-size:16px !important; 
    }
    
    .kontrol-paneli {display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px; margin-bottom:15px}
    @media(max-width:768px){ .kontrol-paneli{grid-template-columns: 1fr} }
    
    table{width:100%;border-collapse:collapse;margin-top:10px; font-size:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:center}
    th{background:#f8f9fa; position: sticky; top: 0; z-index: 10}
    .resim-onizleme{width:60px;height:40px;object-fit:cover;border-radius:3px;cursor:pointer;border:1px solid #ddd}
    
    .rapor-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px}
    .rapor-kutu {padding: 15px; border-radius: 8px; color: white; text-align: center;}
    .mavi {background: #3498db;} .yesil {background: #27ae60;} .turuncu {background: #e67e22;} .mor {background: #9b59b6;}

    .yedek-panel {margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; display: flex; gap: 10px; flex-wrap:wrap}
    .yedek-btn {background: #7f8c8d !important; color: white; font-size: 0.8em; flex:1}
    #resimOnay {color: #27ae60; font-weight: bold; display: none; margin-top: 5px;}
</style>
</head>
<body>

<nav>
    <button onclick="sayfa(1)">GiriÅŸ Yap</button>
    <button onclick="sayfa(2)">Otopark</button>
    <button onclick="sayfa(3)">Teslim</button>
    <button onclick="sayfa(4)">Rapor</button>
</nav>

<div id="s1" class="page active">
    <h3>ðŸš— AraÃ§ GiriÅŸ KaydÄ±</h3>
    <div class="ocr-alan">
        <input type="file" id="fotoSec" accept="image/*" onchange="resimIsle(this)" style="display:none">
        <button onclick="document.getElementById('fotoSec').click()" style="background:#3498db;color:white;font-weight:bold">ðŸ“· ARAÃ‡ RESMÄ° EKLE</button>
        <div id="resimOnay">âœ… Resim HazÄ±r</div>
    </div>
    
    <div id="durumIceride" class="uyari-karti iceride"></div>

    <input id="plaka" placeholder="PLAKA (09 ABK 356)" oninput="plakaKontrol(this.value.toUpperCase())" style="font-size:1.4em !important;font-weight:bold;text-align:center">
    
    <div style="display:flex; gap:10px; flex-wrap:wrap">
        <select id="tip" style="flex:1; min-width:100px">
            <option>Otomobil</option><option>Kamyonet</option><option>Kamyon</option>
            <option>Motosiklet</option><option>OtobÃ¼s</option><option>TraktÃ¶r</option>
        </select>
        <input id="cins" placeholder="AraÃ§ Cinsi (Pejo, Opel, Mondial)" style="flex:1; min-width:120px">
        <input id="kurum" placeholder="BaÄŸlayan Kurum" style="flex:1; min-width:120px">
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap">
        <input type="date" id="giris" style="flex:1; min-width:130px">
        <input id="aciklama" placeholder="AÃ§Ä±klamalar" style="flex:1; min-width:130px">
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap">
        <input type="number" id="ucret" placeholder="GÃ¼nlÃ¼k Ãœcret (â‚º)" style="flex:1">
        <input type="number" id="cekici" placeholder="Ã‡ekici Ãœcreti (â‚º)" style="flex:1">
    </div>
    
    <button id="kaydetButon" onclick="aracEkle()" style="background:#27ae60;color:white;font-weight:bold;padding:15px">ARACI KAYDET</button>

    <div class="yedek-panel">
        <button onclick="yedekAl()" class="yedek-btn">ðŸ’¾ YEDEK Ä°NDÄ°R</button>
        <input type="file" id="yedekDosya" onchange="yedekYukle(this)" style="display:none">
        <button onclick="document.getElementById('yedekDosya').click()" class="yedek-btn">ðŸ“‚ YEDEK YÃœKLE</button>
    </div>
</div>

<div id="s2" class="page">
    <h3>Otoparktaki AraÃ§lar</h3>
    <div class="kontrol-paneli">
        <input id="aramaOto" placeholder="ðŸ” Plaka, Cins, Tarih, BaÄŸlayan Kurum..." oninput="guncelle()">
        <select id="filtreTipOto" onchange="guncelle()">
            <option value="">TÃ¼m Tipler</option>
            <option>Otomobil</option><option>Kamyonet</option><option>Kamyon</option><option>Motosiklet</option>
        </select>
        <select id="siralaOto" onchange="guncelle()">
            <option value="plakaAZ">Plaka (A-Z)</option>
            <option value="plakaZA">Plaka (Z-A)</option>
            <option value="girisYeni">GiriÅŸ (Yeni-Eski)</option>
            <option value="girisEski">GiriÅŸ (Eski-Yeni)</option>
            <option value="cinsAZ">Cins (A-Z)</option>
            <option value="gunCok">GÃ¼n (Ã‡ok-Az)</option>
            <option value="tutarCok">Tutar (Ã‡ok-Az)</option>
        </select>
    </div>
    <div style="overflow-x:auto">
        <table>
            <thead><tr><th>Foto</th><th>Plaka</th><th>Tip</th><th>AraÃ§ Cinsi</th><th>BaÄŸlayan Kurum</th><th>GiriÅŸ Tarihi</th><th>AÃ§Ä±klamalar</th><th>Ã‡ekici</th><th>GÃ¼n</th><th>BorÃ§</th><th>Ä°ÅŸlem</th></tr></thead>
            <tbody id="otoListe"></tbody>
        </table>
    </div>
</div>

<div id="s3" class="page">
    <h3>Teslim Edilen AraÃ§lar</h3>
    <div class="kontrol-paneli">
        <input id="aramaTeslim" placeholder="ðŸ” Arama..." oninput="guncelle()">
        <select id="filtreTipTeslim" onchange="guncelle()">
            <option value="">TÃ¼m Tipler</option>
            <option>Otomobil</option><option>Kamyonet</option><option>Kamyon</option><option>Motosiklet</option>
        </select>
        <select id="siralaTeslim" onchange="guncelle()">
            <option value="girisYeni">Teslim (Yeni-Eski)</option>
            <option value="plakaAZ">Plaka (A-Z)</option>
            <option value="tutarCok">Tahsilat (Ã‡ok-Az)</option>
        </select>
    </div>
    <div style="overflow-x:auto">
        <table>
            <thead><tr><th>Foto</th><th>Plaka</th><th>Tip</th><th>AraÃ§ Cinsi</th><th>BaÄŸlayan Kurum</th><th>GiriÅŸ Tarihi</th><th>Teslim Tarihi</th><th>Ã‡ekici</th><th>Tahsil</th><th>Ä°ÅŸlem</th></tr></thead>
            <tbody id="teslimListe"></tbody>
        </table>
    </div>
</div>

<div id="s4" class="page">
    <h3>ðŸ“Š Finansal Durum</h3>
    <div class="rapor-grid">
        <div class="rapor-kutu mavi">Ä°Ã§erideki<br><h2 id="rOto">0</h2></div>
        <div class="rapor-kutu mor">Teslim Edilen<br><h2 id="rTeslim">0</h2></div>
        <div class="rapor-kutu yesil">Kasa<br><h2>â‚º<span id="rTahsil">0</span></h2></div>
        <div class="rapor-kutu turuncu">Alacak<br><h2>â‚º<span id="rAlacak">0</span></h2></div>
    </div>
</div>

<script>
let araclar = JSON.parse(localStorage.getItem('otopark_veri')) || [];
let mevcutResimData = "";

// --- ZOOM KONTROLÃœ (Ã‡ift TÄ±k) ---
let isZoomed = false;
document.addEventListener('dblclick', function(e) {
    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    if (!isZoomed) {
        document.body.style.transform = "scale(1.25)";
        isZoomed = true;
    } else {
        document.body.style.transform = "scale(1)";
        isZoomed = false;
    }
});

function tarihFormatla(tarihStr) {
    if(!tarihStr) return "-";
    const [y, m, d] = tarihStr.split("-");
    return `${d}.${m}.${y}`;
}

const gunHes = t => Math.max(1, Math.ceil((new Date() - new Date(t)) / 86400000));
const tutarHes = a => (gunHes(a.giris) * a.ucret) + a.cekici;

function sayfa(n){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById("s"+n).classList.add("active");
    guncelle();
}

function plakaFormatla(text) {
    let clean = text.replace(/[^A-Z0-9]/gi, "").toUpperCase();
    let m1 = clean.match(/^(\d{2})([A-Z]{3})(\d{2,4})$/);
    if(m1) return `${m1[1]} ${m1[2]} ${m1[3]}`;
    let m2 = clean.match(/^(\d{2})([A-Z]{2})(\d{3,5})$/);
    if(m2) return `${m2[1]} ${m2[2]} ${m2[3]}`;
    let m3 = clean.match(/^(\d{2})([A-Z]{1})(\d{4})$/);
    if(m3) return `${m3[1]} ${m3[2]} ${m3[3]}`;
    return clean;
}

function resimIsle(input) {
    if (!input.files || !input.files[0]) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const MAX_WIDTH = 800;
            let w = img.width, h = img.height;
            if (w > MAX_WIDTH) { h *= MAX_WIDTH / w; w = MAX_WIDTH; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            mevcutResimData = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('resimOnay').style.display = "block";
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
}

function plakaKontrol(plaka) {
    let formatli = plakaFormatla(plaka);
    if(formatli !== plaka) document.getElementById('plaka').value = formatli;
    const pTemiz = formatli.replace(/\s/g, '');
    const iceride = document.getElementById('durumIceride');
    const btn = document.getElementById('kaydetButon');
    iceride.style.display = "none";
    btn.disabled = false;
    if(pTemiz.length < 4) return;
    let suan = araclar.find(a => a.plaka.replace(/\s/g,'') === pTemiz && !a.cikti);
    if(suan) {
        iceride.innerHTML = `âš ï¸ ARAÃ‡ Ä°Ã‡ERÄ°DE! GiriÅŸ: ${tarihFormatla(suan.giris)} | Cins: ${suan.cins} | BorÃ§: â‚º${tutarHes(suan)}`;
        iceride.style.display = "block"; btn.disabled = true;
    }
}

function aracEkle(){
    const p = document.getElementById('plaka').value.toUpperCase();
    const u = document.getElementById('ucret').value;
    const g = document.getElementById('giris').value;
    if(!p || !u || !g) return alert("Plaka, GiriÅŸ Tarihi ve Ãœcret girin!");
    araclar.push({
        plaka: p, tip: document.getElementById('tip').value,
        cins: document.getElementById('cins').value,
        kurum: document.getElementById('kurum').value,
        giris: g, aciklama: document.getElementById('aciklama').value,
        ucret: +u, cekici: +document.getElementById('cekici').value || 0,
        resim: mevcutResimData, cikti: false
    });
    localStorage.setItem('otopark_veri', JSON.stringify(araclar));
    ['plaka','cins','kurum','aciklama','ucret','cekici'].forEach(id => document.getElementById(id).value = "");
    mevcutResimData = ""; document.getElementById('resimOnay').style.display = "none";
    alert("KayÄ±t Edildi!");
    guncelle();
}

function listeYÃ¶net(liste, araId, tipId, siralaId) {
    let q = document.getElementById(araId).value.toLowerCase().trim();
    let qC = q.replace(/[\s\.\-]/g, ""); 
    let t = document.getElementById(tipId).value;
    let s = document.getElementById(siralaId).value;

    let sonuc = liste.filter(a => {
        if (t !== "" && a.tip !== t) return false;
        if (!q) return true;
        let pC = a.plaka.replace(/[\s\.\-]/g, "").toLowerCase();
        let trh = tarihFormatla(a.giris);
        return pC.includes(qC) || (a.cins||"").toLowerCase().includes(q) || 
               (a.kurum||"").toLowerCase().includes(q) || (a.aciklama||"").toLowerCase().includes(q) || 
               trh.includes(q);
    });

    return sonuc.sort((a, b) => {
        switch(s) {
            case "plakaAZ": return a.plaka.localeCompare(b.plaka);
            case "plakaZA": return b.plaka.localeCompare(a.plaka);
            case "girisYeni": return b.giris.localeCompare(a.giris);
            case "girisEski": return a.giris.localeCompare(b.giris);
            case "cinsAZ": return (a.cins || "").localeCompare(b.cins || "");
            case "gunCok": return (a.cikti ? b.gun - a.gun : gunHes(b.giris) - gunHes(a.giris));
            case "tutarCok": return (a.cikti ? b.tutar - a.tutar : tutarHes(b) - tutarHes(a));
            default: return 0;
        }
    });
}

function guncelle(){
    let aktifler = listeYÃ¶net(araclar.filter(a => !a.cikti), 'aramaOto', 'filtreTipOto', 'siralaOto');
    let pasifler = listeYÃ¶net(araclar.filter(a => a.cikti), 'aramaTeslim', 'filtreTipTeslim', 'siralaTeslim');

    document.getElementById('otoListe').innerHTML = aktifler.map(a => `
        <tr>
            <td><img src="${a.resim || ''}" class="resim-onizleme" onclick="window.open(this.src)" onerror="this.style.display='none'"></td>
            <td><b>${a.plaka}</b></td>
            <td>${a.tip}</td>
            <td>${a.cins || '-'}</td>
            <td>${a.kurum || '-'}</td>
            <td>${tarihFormatla(a.giris)}</td>
            <td>${a.aciklama || '-'}</td>
            <td>â‚º${a.cekici}</td>
            <td>${gunHes(a.giris)}</td>
            <td><b>â‚º${tutarHes(a)}</b></td>
            <td><button onclick="teslimEt(${araclar.indexOf(a)})" style="background:#e67e22;color:white;border:none;padding:5px;font-size:12px !important">TESLÄ°M</button></td>
        </tr>`).join("");

    document.getElementById('teslimListe').innerHTML = pasifler.map(a => `
        <tr>
            <td><img src="${a.resim || ''}" class="resim-onizleme" onclick="window.open(this.src)" onerror="this.style.display='none'"></td>
            <td>${a.plaka}</td>
            <td>${a.tip}</td>
            <td>${a.cins || '-'}</td>
            <td>${a.kurum || '-'}</td>
            <td>${tarihFormatla(a.giris)}</td>
            <td>${tarihFormatla(a.cikis)}</td>
            <td>â‚º${a.cekici}</td>
            <td>â‚º${a.tutar}</td>
            <td><button onclick="sil(${araclar.indexOf(a)})" style="background:#c0392b;color:white;border:none;padding:5px;font-size:12px !important">SÄ°L</button></td>
        </tr>`).join("");

    document.getElementById('rOto').innerText = araclar.filter(a=>!a.cikti).length;
    document.getElementById('rTeslim').innerText = araclar.filter(a=>a.cikti).length;
    document.getElementById('rTahsil').innerText = araclar.filter(a=>a.cikti).reduce((s,a)=> s+a.tutar, 0);
    document.getElementById('rAlacak').innerText = araclar.filter(a=>!a.cikti).reduce((s,a)=> s+tutarHes(a), 0);
}

function teslimEt(i){
    let a = araclar[i];
    a.gun = gunHes(a.giris);
    a.tutar = tutarHes(a);
    a.cikis = new Date().toISOString().slice(0,10);
    a.cikti = true;
    localStorage.setItem('otopark_veri', JSON.stringify(araclar));
    guncelle();
}

function sil(i){ if(confirm("Silinsin mi?")){ araclar.splice(i,1); localStorage.setItem('otopark_veri', JSON.stringify(araclar)); guncelle(); } }
function yedekAl() {
    const blob = new Blob([JSON.stringify(araclar)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `yedek_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
}
function yedekYukle(input) {
    const reader = new FileReader();
    reader.onload = e => { araclar = JSON.parse(e.target.result); localStorage.setItem('otopark_veri', JSON.stringify(araclar)); guncelle(); alert("YÃ¼klendi!"); };
    reader.readAsText(input.files[0]);
}
document.getElementById('giris').valueAsDate = new Date();
guncelle();
</script>
</body>
</html>
